steps:
- name: gcr.io/cloud-builders/gsutil
  # TODO relative path to local file?
  args: ['cp', '-r', '${_CODE_PATH}/preprocess', 'gs://$REPO_NAME/$COMMIT_SHA/preprocess']
  id: 'UploadPreprocessCode'
- name: 'python:2-alpine'
  entrypoint: '/bin/sh'
  args: ['-c', 'cd ${_CODE_PATH}/train; python setup.py sdist; cp dist/*.tar.gz /workspace/train.tar.gz']
  id:   'PackageTrainingCode'
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', '/workspace/train.tar.gz', 'gs://$REPO_NAME/$COMMIT_SHA/train/train.tar.gz']
  id:   'UploadTrainingCode'
  waitFor: ['PackageTrainingCode']
- name: 'python:3.6-slim'
  entrypoint: '/bin/sh'
  args: ['-c', 'cd ${_CODE_PATH};
                pip3 install https://storage.googleapis.com/kfpci/kfp-0.1.22.tar.gz;
                python resnet-train-pipeline.py --package_base_dir gs://$REPO_NAME/$COMMIT_SHA;
                cp resnet-train-pipeline.py.zip /workspace/resnet-train-pipeline.zip']
  id:   'PackagePipeline'
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', '/workspace/resnet-train-pipeline.zip', 'gs://$REPO_NAME/$COMMIT_SHA/resnet-train-pipeline.zip']
  id:   'UploadPipeline'
  waitFor: ['PackagePipeline']
- name: gcr.io/cloud-builders/kubectl
  entrypoint: '/bin/sh'
  args: ['-c', '/builder/kubectl.bash; apt update;
                apt-get install -y python3 python-dev python3-dev build-essential libssl-dev libffi-dev libxml2-dev libxslt1-dev zlib1g-dev python-pip;
                apt install -y python3-pip;
                pip3 install https://storage.googleapis.com/kfpci/kfp-0.1.22.tar.gz;
                python3 -c "import kfp; client=kfp.Client(namespace=\"kubeflow\"); client.create_pipeline_version(pipeline_id=\"d564d407-efa9-4c84-8165-0c5e0468b6f9\",name=\"$COMMIT_SHA\",url=\"https://storage.googleapis.com/$REPO_NAME/$COMMIT_SHA/resnet-train-pipeline.zip\")"']
  env:
  - 'CLOUDSDK_COMPUTE_REGION=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=kfci'


substitutions:
  _CODE_PATH: /workspace/experiment/ci/resnet-cmle
