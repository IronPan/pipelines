FROM golang:1.11 as builder

WORKDIR /go/src/github.com/kubeflow/pipelines
COPY . .

# Needed for github.com/mattn/go-sqlite3
RUN apt-get update && apt-get install gcc musl-dev

RUN export GO111MODULE=on && go build -o /bin/persistence_agent backend/src/agent/persistence/*.go

FROM alpine:3.8
WORKDIR /bin

COPY --from=builder /bin/persistence_agent /bin/persistence_agent
COPY --from=builder /go/src/github.com/kubeflow/pipelines/third_party/license.txt /bin/license.txt

CMD persistence_agent \
  --alsologtostderr=true
